{{set . "title" "Chat room"}}
{{template "header.html" .}}

<h1>
  <div class="row">
    <div class="col-sm-8 bg-info">You are now chatting as {{.user}}!</div> 
    <div class="col-sm-2 bg-warning">Tired?</div>  
    <div class="col-sm-2 bg-dark">  
      <a id="leave" href="/">Leave</a>
    </div>
  </div>
</h1>
<div id="chatWrapper">
        <div id="thread">
                <script type="text/html" id="message_tmpl">
                  {{raw "<%"}} if(event.Type == 'message') { %>
                  <div class="received_msg">
                    <div class="received_withd_msg">
                        <p>{{raw "<%"}}= event.User %>: {{raw "<%"}}= event.Text %></p>
                    </div>
                  </div>
                  {{raw "<%"}} } %>
                  {{raw "<%"}} if(event.Type == 'join') { %>
                  <div class="received_alert">
                    <div class="received_withd_msg">
                          <p>{{raw "<%"}}= event.User %> joined the room</p>
                    </div>
                  </div>
                  {{raw "<%"}} } %>
                  {{raw "<%"}} if(event.Type == 'leave') { %>
                  <div class="received_alert">
                    <div class="received_withd_msg">
                          <p>{{raw "<%"}}= event.User %> left the room</p>
                    </div>
                  </div>
                  {{raw "<%"}} } %>
                  {{raw "<%"}} if(event.Type == 'quit') { %>
                  <div class="received_msg">
                    <div class="received_withd_msg">
                          <p>You are disconnected!</p>
                          <span class="time_date"> 11:01 AM    |    Today</span>
                    </div>
                  </div>
                  {{raw "<%"}} } %>
                  </script>
        </div>
  <div class="type_msg" id="newMessage">
      <div class="input_msg_write">
        <input type="text" class="write_msg" id="message" placeholder="Type a message" />
        <button class="msg_send_btn" type="submit" id="send"><i class="fa fa-paper-plane-o" aria-hidden="true"></i></button>
      </div>
  </div>

</div>

  <!-- <div class="input-group mb-3" id="newMessage">
    <input type="text" id="message" autocomplete="off" autofocus>
    <div class="input-group-append">
        <input type="submit" value="send" class="btn btn-dark" id="send">
    </div>
  </div> -->


<script type="text/javascript">

  // Create a socket
  var socket = new WebSocket('ws://'+window.location.host+'/websocket/room/socket?user={{.user}}')

  // Display a message
  var display = function(event) {
    $('#thread').append(tmpl('message_tmpl', {event: event}));
    $('#thread').scrollTo('max')
  }

  // Message received on the socket
  socket.onmessage = function(event) {
    display(JSON.parse(event.data))
  }

  $('#send').click(function(e) {
    var message = $('#message').val()
    $('#message').val('')
    socket.send(JSON.stringify(message))
  });

  $('#message').keypress(function(e) {
    if(e.charCode == 13 || e.keyCode == 13) {
      $('#send').click()
      e.preventDefault()
    }
  })

</script>
